{% extends 'base.html' %}
{% load static %}

{% block header %}Sales{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Product list for sales -->
    <div class="md:col-span-2">
        <div class="mb-6">
            <h2 class="text-2xl font-semibold mb-4">Products</h2>
            <!-- Search and filter controls -->
            <div class="flex space-x-4 mb-4">
                <div class="flex-1">
                    <input type="text" 
                           id="searchInput" 
                           placeholder="Search products to display..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center">
                    <label class="mr-2">Sort:</label>
                    <select id="sortSelect" 
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="asc">A to Z</option>
                        <option value="desc">Z to A</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for product in products %}
            <div class="bg-white rounded-lg shadow-md p-4 product-card hidden" 
                 data-name="{{ product.name|lower }}" 
                 data-price="{{ product.selling_price }}">
                <h3 class="text-lg font-semibold">{{ product.name }}</h3>
                <p class="text-gray-600">Price: ${{ product.selling_price }}</p>
                <p class="text-gray-600">Stock: {{ product.stock_quantity }}</p>
                <button class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded add-to-cart" 
                        data-product-id="{{ product.id }}">
                    Add to Cart
                </button>
            </div>
            {% endfor %}
        </div>

        <!-- No results message -->
        <div id="noResults" class="hidden text-center py-8 text-gray-500">
            No products found matching your search.
        </div>

        <!-- Initial message -->
        <div id="initialMessage" class="text-center py-8 text-gray-500">
            Type in the search box to display products
        </div>
    </div>

    <!-- Shopping cart section remains the same -->
    <div class="bg-white rounded-lg shadow-md p-4">
        <h2 class="text-2xl font-semibold mb-4">Shopping Cart</h2>
        <ul id="shopping-cart" class="space-y-2">
            <!-- Cart items will be added here dynamically -->
        </ul>
        <div class="mt-4">
            <h4 class="text-xl font-semibold">Total: $<span id="cart-total">0.00</span></h4>
            <button id="checkout-button" 
                    class="mt-2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded w-full">
                Checkout
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cart functionality
    const cart = {};
    const cartList = document.getElementById('shopping-cart');
    const cartTotal = document.getElementById('cart-total');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const productsGrid = document.getElementById('productsGrid');
    const noResults = document.getElementById('noResults');
    const initialMessage = document.getElementById('initialMessage');

    // Search and sort functionality
    function filterAndSortProducts() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const sortMethod = sortSelect.value;
        const productCards = Array.from(document.querySelectorAll('.product-card'));

        // Hide initial message if there's a search term
        initialMessage.style.display = searchTerm ? 'none' : 'block';

        // If no search term, hide all products and show initial message
        if (!searchTerm) {
            productCards.forEach(card => card.classList.add('hidden'));
            noResults.classList.add('hidden');
            return;
        }

        // Filter products
        let visibleCards = productCards.filter(card => {
            const productName = card.getAttribute('data-name');
            const shouldShow = productName.includes(searchTerm);
            card.classList.toggle('hidden', !shouldShow);
            return shouldShow;
        });

        // Show/hide no results message
        noResults.classList.toggle('hidden', visibleCards.length > 0);

        // Sort visible cards
        visibleCards.sort((a, b) => {
            const nameA = a.getAttribute('data-name');
            const nameB = b.getAttribute('data-name');
            const priceA = parseFloat(a.getAttribute('data-price'));
            const priceB = parseFloat(b.getAttribute('data-price'));

            switch(sortMethod) {
                case 'asc':
                    return nameA.localeCompare(nameB);
                case 'desc':
                    return nameB.localeCompare(nameA);
                case 'price-low':
                    return priceA - priceB;
                case 'price-high':
                    return priceB - priceA;
                default:
                    return 0;
            }
        });

        // Reorder in DOM
        visibleCards.forEach(card => productsGrid.appendChild(card));
    }

    // Event listeners for search and sort
    searchInput.addEventListener('input', filterAndSortProducts);
    sortSelect.addEventListener('change', filterAndSortProducts);

    // Cart functionality remains the same
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const productCard = this.closest('.product-card');
            const productName = productCard.querySelector('h3').textContent;
            const productPrice = parseFloat(productCard.querySelector('p').textContent.split('$')[1]);

            if (cart[productId]) {
                cart[productId].quantity += 1;
            } else {
                cart[productId] = { name: productName, price: productPrice, quantity: 1 };
            }

            updateCart();
        });
    });

    function updateCart() {
        cartList.innerHTML = '';
        let total = 0;

        for (const [id, item] of Object.entries(cart)) {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center';
            li.innerHTML = `
                <span>${item.name} - $${item.price} x ${item.quantity}</span>
                <button class="text-red-500 hover:text-red-600" onclick="removeFromCart('${id}')">Remove</button>
            `;
            cartList.appendChild(li);

            total += item.price * item.quantity;
        }

        cartTotal.textContent = total.toFixed(2);
    }

    window.removeFromCart = function(productId) {
        delete cart[productId];
        updateCart();
    }

    document.getElementById('checkout-button').addEventListener('click', function() {
        // Implement checkout logic here
        alert('Checkout functionality to be implemented');
    });
});
</script>
{% endblock %}